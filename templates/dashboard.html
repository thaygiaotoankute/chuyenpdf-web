{% extends "base.html" %}

{% block title %}P_Convert - Dashboard{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
{% endblock %}

{% block content %}
<div class="main-content">
    <h1>P_Convert_2025_Special (PDF:Word-Image-Equation)</h1>
    <p>C√¥ng c·ª• chuy·ªÉn ƒë·ªïi PDF th√†nh vƒÉn b·∫£n, h√¨nh ·∫£nh v√† c√¥ng th·ª©c to√°n h·ªçc</p>
    
    <!-- API Keys Card -->
    <div class="card">
        <h2 class="card-title">API Keys</h2>
        <div class="form-group">
            <label for="mineru-token">Mineru Token</label>
            <input type="password" id="mineru-token" placeholder="Nh·∫≠p Mineru Token...">
            <button class="btn-toggle-password" data-target="mineru-token">üëÅ</button>
        </div>
        <div class="form-group">
            <label for="gemini-key">Gemini API Key</label>
            <input type="password" id="gemini-key" placeholder="Nh·∫≠p Gemini API Key...">
            <button class="btn-toggle-password" data-target="gemini-key">üëÅ</button>
        </div>
    </div>
    
    <!-- File Upload Card -->
    <div class="card">
        <h2 class="card-title">Upload PDF</h2>
        <div class="file-drop-area" id="file-drop-area">
            <p>K√©o th·∫£ file PDF v√†o ƒë√¢y ho·∫∑c <strong>Click ƒë·ªÉ ch·ªçn file</strong></p>
            <input type="file" id="file-input" class="file-input" accept=".pdf">
        </div>
        
        <div id="file-info-container" class="hidden">
            <div class="file-info">
                <div class="file-name" id="file-name"></div>
                <div class="file-size" id="file-size"></div>
                <button class="btn-error" id="btn-remove-file">X√≥a</button>
            </div>
        </div>
    </div>
    
    <!-- Tabs Card -->
    <div class="card" id="processing-options" style="display: none;">
        <div class="tabs">
            <div class="tab active" data-tab="full-pdf">X·ª≠ l√Ω to√†n b·ªô PDF</div>
            <div class="tab" data-tab="split-pdf">T√°ch v√† x·ª≠ l√Ω t·ª´ng ph·∫ßn</div>
        </div>
        
        <!-- Tab Content -->
        <div class="tab-content active" id="full-pdf-tab">
            <p>X·ª≠ l√Ω to√†n b·ªô file PDF v√† tr√≠ch xu·∫•t th√†nh vƒÉn b·∫£n</p>
            <button class="btn" id="btn-process-all">Upload & Parse (To√†n b·ªô PDF)</button>
            <div class="progress-container" id="progress-container-full" style="display: none;">
                <div class="progress-bar" id="progress-bar-full"></div>
            </div>
            <div id="status-text-full" class="status-text"></div>
        </div>
        
        <div class="tab-content" id="split-pdf-tab">
            <p>T√°ch PDF th√†nh nhi·ªÅu ph·∫ßn ƒë·ªÉ x·ª≠ l√Ω t·ª´ng ph·∫ßn</p>
            <button class="btn" id="btn-split-pdf">T√°ch PDF</button>
            <div id="parts-container" style="display: none;">
                <h3>C√°c ph·∫ßn ƒë√£ t√°ch</h3>
                <ul class="parts-list" id="parts-list"></ul>
                <div class="action-buttons">
                    <button class="btn" id="btn-process-selected-part">X·ª≠ l√Ω ph·∫ßn ƒë√£ ch·ªçn</button>
                    <button class="btn" id="btn-process-all-parts">X·ª≠ l√Ω t·∫•t c·∫£ c√°c ph·∫ßn</button>
                </div>
                <div class="progress-container" id="progress-container-part" style="display: none;">
                    <div class="progress-bar" id="progress-bar-part"></div>
                </div>
                <div id="status-text-part" class="status-text"></div>
            </div>
        </div>
    </div>
    
    <!-- Results Card -->
    <div class="card" id="results-card" style="display: none;">
        <h2 class="card-title">K·∫øt qu·∫£</h2>
        <div class="tabs">
            <div class="tab active" data-tab="preview">Xem k·∫øt qu·∫£</div>
            <div class="tab" data-tab="download">T·∫£i xu·ªëng</div>
        </div>
        
        <div class="tab-content active" id="preview-tab">
            <div class="markdown-preview" id="markdown-preview"></div>
        </div>
        
        <div class="tab-content" id="download-tab">
            <p>T·∫£i xu·ªëng k·∫øt qu·∫£</p>
            <div class="action-buttons">
                <a class="btn" id="btn-download-md">T·∫£i xu·ªëng d∆∞·ªõi d·∫°ng Markdown</a>
                <a class="btn" id="btn-download-txt">T·∫£i xu·ªëng d∆∞·ªõi d·∫°ng Text</a>
            </div>
            <div class="alert alert-info">
                L∆∞u √Ω: Vi·ªác chuy·ªÉn ƒë·ªïi sang Word y√™u c·∫ßu Pandoc ƒë∆∞·ª£c c√†i ƒë·∫∑t tr√™n m√°y t√≠nh c·ªßa b·∫°n. 
                B·∫°n c√≥ th·ªÉ t·∫£i xu·ªëng ƒë·ªãnh d·∫°ng Markdown v√† s·ª≠ d·ª•ng c√°c c√¥ng c·ª• chuy·ªÉn ƒë·ªïi nh∆∞ Pandoc.
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables
    let fileId = null;
    let fileName = null;
    let fileData = null;
    let activeTaskId = null;
    let selectedPartId = null;
    let parts = [];
    let resultText = '';
    
    // Elements
    const fileDropArea = document.getElementById('file-drop-area');
    const fileInput = document.getElementById('file-input');
    const fileInfoContainer = document.getElementById('file-info-container');
    const fileNameEl = document.getElementById('file-name');
    const fileSizeEl = document.getElementById('file-size');
    const btnRemoveFile = document.getElementById('btn-remove-file');
    const processingOptions = document.getElementById('processing-options');
    const btnProcessAll = document.getElementById('btn-process-all');
    const btnSplitPdf = document.getElementById('btn-split-pdf');
    const progressContainerFull = document.getElementById('progress-container-full');
    const progressBarFull = document.getElementById('progress-bar-full');
    const statusTextFull = document.getElementById('status-text-full');
    const partsContainer = document.getElementById('parts-container');
    const partsList = document.getElementById('parts-list');
    const btnProcessSelectedPart = document.getElementById('btn-process-selected-part');
    const btnProcessAllParts = document.getElementById('btn-process-all-parts');
    const progressContainerPart = document.getElementById('progress-container-part');
    const progressBarPart = document.getElementById('progress-bar-part');
    const statusTextPart = document.getElementById('status-text-part');
    const resultsCard = document.getElementById('results-card');
    const markdownPreview = document.getElementById('markdown-preview');
    const btnDownloadMd = document.getElementById('btn-download-md');
    const btnDownloadTxt = document.getElementById('btn-download-txt');
    
    // Password Toggle
    document.querySelectorAll('.btn-toggle-password').forEach(function(button) {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        });
    });
    
    // Tab Switching
    document.querySelectorAll('.tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            const tabId = this.getAttribute('data-tab');
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId + '-tab').classList.add('active');
        });
    });
    
    // File Upload Handling
    fileDropArea.addEventListener('click', function() {
        fileInput.click();
    });
    
    fileDropArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileDropArea.classList.add('dragover');
    });
    
    fileDropArea.addEventListener('dragleave', function() {
        fileDropArea.classList.remove('dragover');
    });
    
    fileDropArea.addEventListener('drop', function(e) {
        e.preventDefault();
        fileDropArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length) {
            handleFileUpload(e.dataTransfer.files[0]);
        }
    });
    
    fileInput.addEventListener('change', function() {
        if (fileInput.files.length) {
            handleFileUpload(fileInput.files[0]);
        }
    });
    
    btnRemoveFile.addEventListener('click', function() {
        resetFileUpload();
    });
    
    function handleFileUpload(file) {
        if (!file.type || file.type !== 'application/pdf') {
            alert('Ch·ªâ ch·∫•p nh·∫≠n file PDF!');
            return;
        }
        
        // Display file info
        fileName = file.name;
        fileNameEl.textContent = fileName;
        fileSizeEl.textContent = formatFileSize(file.size);
        fileInfoContainer.style.display = 'block';
        processingOptions.style.display = 'block';
        
        // Upload file to server
        const formData = new FormData();
        formData.append('pdf_file', file);
        
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                fileId = data.file_id;
                // Show success message
                console.log('File uploaded successfully', data);
            } else {
                alert(data.error || 'Upload failed');
                resetFileUpload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading file');
            resetFileUpload();
        });
    }
    
    function resetFileUpload() {
        fileInput.value = '';
        fileInfoContainer.style.display = 'none';
        processingOptions.style.display = 'none';
        partsContainer.style.display = 'none';
        resultsCard.style.display = 'none';
        fileId = null;
        fileName = null;
        parts = [];
    }
    
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
    
    // Process Full PDF
    btnProcessAll.addEventListener('click', function() {
        if (!fileId) {
            alert('Vui l√≤ng ch·ªçn file PDF tr∆∞·ªõc');
            return;
        }
        
        const mineruToken = document.getElementById('mineru-token').value;
        const geminiKey = document.getElementById('gemini-key').value;
        
        if (!mineruToken) {
            alert('Vui l√≤ng nh·∫≠p Mineru Token');
            return;
        }
        
        // Show progress bar
        progressContainerFull.style.display = 'block';
        progressBarFull.style.width = '0%';
        statusTextFull.textContent = 'ƒêang b·∫Øt ƒë·∫ßu x·ª≠ l√Ω...';
        btnProcessAll.disabled = true;
        
        fetch('/process', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_id: fileId,
                filename: fileName,
                mineru_token: mineruToken,
                gemini_key: geminiKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                activeTaskId = data.task_id;
                // Poll for task status
                pollTaskStatus(activeTaskId, updateFullPdfProgress);
            } else {
                alert(data.error || 'Processing failed');
                progressContainerFull.style.display = 'none';
                btnProcessAll.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing file');
            progressContainerFull.style.display = 'none';
            btnProcessAll.disabled = false;
        });
    });
    
    function updateFullPdfProgress(taskInfo) {
        progressBarFull.style.width = taskInfo.progress + '%';
        
        switch (taskInfo.status) {
            case 'initialized':
                statusTextFull.textContent = 'Kh·ªüi t·∫°o...';
                break;
            case 'uploading':
                statusTextFull.textContent = 'ƒêang upload PDF...';
                break;
            case 'processing':
                statusTextFull.textContent = 'ƒêang x·ª≠ l√Ω PDF...';
                break;
            case 'downloading':
                statusTextFull.textContent = 'ƒêang t·∫£i k·∫øt qu·∫£...';
                break;
            case 'correcting':
                statusTextFull.textContent = 'ƒêang hi·ªáu ƒë√≠nh n·ªôi dung v·ªõi Gemini...';
                break;
            case 'completed':
                statusTextFull.textContent = 'ƒê√£ ho√†n th√†nh!';
                getTaskResult(activeTaskId);
                btnProcessAll.disabled = false;
                break;
            case 'error':
                statusTextFull.textContent = 'L·ªói: ' + taskInfo.error;
                btnProcessAll.disabled = false;
                break;
            case 'cancelled':
                statusTextFull.textContent = 'ƒê√£ h·ªßy x·ª≠ l√Ω';
                btnProcessAll.disabled = false;
                break;
            default:
                statusTextFull.textContent = 'ƒêang x·ª≠ l√Ω...';
        }
    }
    
    // Split PDF
    btnSplitPdf.addEventListener('click', function() {
        if (!fileId) {
            alert('Vui l√≤ng ch·ªçn file PDF tr∆∞·ªõc');
            return;
        }
        
        btnSplitPdf.disabled = true;
        statusTextPart.textContent = 'ƒêang t√°ch PDF...';
        
        fetch('/split-pdf', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_id: fileId,
                filename: fileName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                parts = data.parts;
                
                // Display parts list
                partsList.innerHTML = '';
                parts.forEach(part => {
                    const li = document.createElement('li');
                    li.className = 'part-item';
                    li.dataset.partId = part.id;
                    li.textContent = part.name;
                    li.addEventListener('click', function() {
                        // Select part
                        document.querySelectorAll('.part-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        selectedPartId = part.id;
                    });
                    partsList.appendChild(li);
                });
                
                partsContainer.style.display = 'block';
                statusTextPart.textContent = 'PDF ƒë√£ ƒë∆∞·ª£c t√°ch th√†nh ' + parts.length + ' ph·∫ßn';
            } else {
                alert(data.error || 'Split failed');
            }
            btnSplitPdf.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error splitting file');
            btnSplitPdf.disabled = false;
        });
    });
    
    // Process Selected Part
    btnProcessSelectedPart.addEventListener('click', function() {
        if (!selectedPartId) {
            alert('Vui l√≤ng ch·ªçn m·ªôt ph·∫ßn ƒë·ªÉ x·ª≠ l√Ω');
            return;
        }
        
        processSelectedPart(selectedPartId);
    });
    
    function processSelectedPart(partId) {
        const mineruToken = document.getElementById('mineru-token').value;
        const geminiKey = document.getElementById('gemini-key').value;
        
        if (!mineruToken) {
            alert('Vui l√≤ng nh·∫≠p Mineru Token');
            return;
        }
        
        // Show progress
        progressContainerPart.style.display = 'block';
        progressBarPart.style.width = '0%';
        statusTextPart.textContent = 'ƒêang b·∫Øt ƒë·∫ßu x·ª≠ l√Ω ph·∫ßn ' + partId + '...';
        btnProcessSelectedPart.disabled = true;
        btnProcessAllParts.disabled = true;
        
        fetch('/process-part', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_id: fileId,
                part_id: partId,
                mineru_token: mineruToken,
                gemini_key: geminiKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                activeTaskId = data.task_id;
                // Poll for task status
                pollTaskStatus(activeTaskId, updatePartProgress);
            } else {
                alert(data.error || 'Processing failed');
                progressContainerPart.style.display = 'none';
                btnProcessSelectedPart.disabled = false;
                btnProcessAllParts.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing part');
            progressContainerPart.style.display = 'none';
            btnProcessSelectedPart.disabled = false;
            btnProcessAllParts.disabled = false;
        });
    }
    
    // Process All Parts
    btnProcessAllParts.addEventListener('click', function() {
        if (parts.length === 0) {
            alert('Kh√¥ng c√≥ ph·∫ßn n√†o ƒë·ªÉ x·ª≠ l√Ω');
            return;
        }
        
        // Reset result text before processing all parts
        resultText = '';
        
        // Process first part
        processAllPartsSequentially(0);
    });
    
    function processAllPartsSequentially(index) {
        if (index >= parts.length) {
            // All parts are processed
            btnProcessSelectedPart.disabled = false;
            btnProcessAllParts.disabled = false;
            return;
        }
        
        const partId = parts[index].id;
        const mineruToken = document.getElementById('mineru-token').value;
        const geminiKey = document.getElementById('gemini-key').value;
        
        if (!mineruToken) {
            alert('Vui l√≤ng nh·∫≠p Mineru Token');
            return;
        }
        
        // Show progress
        progressContainerPart.style.display = 'block';
        progressBarPart.style.width = '0%';
        statusTextPart.textContent = `ƒêang x·ª≠ l√Ω ph·∫ßn ${index+1}/${parts.length}...`;
        btnProcessSelectedPart.disabled = true;
        btnProcessAllParts.disabled = true;
        
        fetch('/process-part', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_id: fileId,
                part_id: partId,
                mineru_token: mineruToken,
                gemini_key: geminiKey
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                activeTaskId = data.task_id;
                
                // Set up callback for when this part is done
                const originalPollCallback = pollTaskStatus(activeTaskId, updatePartProgress, () => {
                    // After this part is done, process the next part
                    setTimeout(() => {
                        processAllPartsSequentially(index + 1);
                    }, 1000);
                });
            } else {
                alert(data.error || 'Processing failed');
                progressContainerPart.style.display = 'none';
                btnProcessSelectedPart.disabled = false;
                btnProcessAllParts.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing parts');
            progressContainerPart.style.display = 'none';
            btnProcessSelectedPart.disabled = false;
            btnProcessAllParts.disabled = false;
        });
    }
    
    function updatePartProgress(taskInfo) {
        progressBarPart.style.width = taskInfo.progress + '%';
        
        switch (taskInfo.status) {
            case 'initialized':
                statusTextPart.textContent = 'Kh·ªüi t·∫°o...';
                break;
            case 'uploading':
                statusTextPart.textContent = 'ƒêang upload PDF...';
                break;
            case 'processing':
                statusTextPart.textContent = 'ƒêang x·ª≠ l√Ω PDF...';
                break;
            case 'downloading':
                statusTextPart.textContent = 'ƒêang t·∫£i k·∫øt qu·∫£...';
                break;
            case 'correcting':
                statusTextPart.textContent = 'ƒêang hi·ªáu ƒë√≠nh n·ªôi dung v·ªõi Gemini...';
                break;
            case 'completed':
                statusTextPart.textContent = 'ƒê√£ ho√†n th√†nh!';
                getTaskResult(activeTaskId, true);
                btnProcessSelectedPart.disabled = false;
                btnProcessAllParts.disabled = false;
                break;
            case 'error':
                statusTextPart.textContent = 'L·ªói: ' + taskInfo.error;
                btnProcessSelectedPart.disabled = false;
                btnProcessAllParts.disabled = false;
                break;
            case 'cancelled':
                statusTextPart.textContent = 'ƒê√£ h·ªßy x·ª≠ l√Ω';
                btnProcessSelectedPart.disabled = false;
                btnProcessAllParts.disabled = false;
                break;
            default:
                statusTextPart.textContent = 'ƒêang x·ª≠ l√Ω...';
        }
    }
    
    // Task Status Polling
    function pollTaskStatus(taskId, updateCallback, completionCallback = null) {
        const poll = () => {
            fetch(`/task-status/${taskId}`)
                .then(response => response.json())
                .then(taskInfo => {
                    updateCallback(taskInfo);
                    
                    if (['completed', 'error', 'cancelled'].includes(taskInfo.status)) {
                        if (completionCallback) {
                            completionCallback();
                        }
                        return;
                    }
                    
                    // Continue polling
                    setTimeout(poll, 1000);
                })
                .catch(error => {
                    console.error('Error polling task status:', error);
                    // Retry after a delay
                    setTimeout(poll, 2000);
                });
        };
        
        // Start polling
        poll();
    }
    
    // Get Task Result
    function getTaskResult(taskId, append = false) {
        fetch(`/task-result/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (append) {
                        // Append result to existing text
                        if (resultText) {
                            resultText += '\n\n';
                        }
                        
                        if (data.part_name) {
                            resultText += `--- K·∫øt qu·∫£ t·ª´ ${data.part_name} ---\n`;
                        }
                        
                        resultText += data.result;
                    } else {
                        // Replace existing result
                        resultText = data.result;
                    }
                    
                    // Update preview
                    markdownPreview.innerHTML = marked.parse(resultText);
                    
                    // Update download links
                    btnDownloadMd.href = `/download/${taskId}/markdown`;
                    btnDownloadTxt.href = `/download/${taskId}/text`;
                    
                    // Show results card
                    resultsCard.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error getting result:', error);
            });
    }
});
</script>
{% endblock %}
